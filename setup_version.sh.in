#!/bin/bash

if [ $# -ne 2 ]; then
    echo $0: usage: setup_version version
    exit 1
fi

VERSION="`cat $1`"
TARGET_FILE=$2

# Seperate the dot limited version number into its components
IFS='.-' read major minor patch build <<EOF
$VERSION
EOF

if [ ! -f $TARGET_FILE ]; then
	# Write out the header file into the source directory
	echo "/**"                                                                    > $TARGET_FILE
	echo " * THIS FILE IS AUTOMATICALLY GENERATED - DO NOT MODIFY!"               >> $TARGET_FILE
	echo " * @file"                                                               >> $TARGET_FILE  
	echo " * The library version in Semantic Versioning 2.0.0 format. Users are"  >> $TARGET_FILE  
	echo " * responsible for modifying the three version numbers as appropriate"  >> $TARGET_FILE 
	echo " # in the version file."                                                >> $TARGET_FILE      
	echo " * A macro is used to provide a dot-separated string representation of" >> $TARGET_FILE    
	echo " * the version number with associated build date and time."             >> $TARGET_FILE 
	echo " *"                                                                     >> $TARGET_FILE   
	echo " * @brief Library version information."                                 >> $TARGET_FILE      
	echo " */"                                                                    >> $TARGET_FILE  
	echo ""                                                                       >> $TARGET_FILE 
	echo "#pragma once" >> $TARGET_FILE
	echo "" >> $TARGET_FILE
	echo "#define MAJOR_VERSION     $major" >> $TARGET_FILE
	echo "#define MINOR_VERSION     $minor" >> $TARGET_FILE
	echo "#define BUILD_VERSION     $build" >> $TARGET_FILE
	echo "#define PATCH_VERSION     $patch" >> $TARGET_FILE
	echo "#define BUILD_DATE        __DATE__" >> $TARGET_FILE
	echo "#define BUILD_TIME        __TIME__" >> $TARGET_FILE
	echo "#define STRINGSIZE2(s) #s" >> $TARGET_FILE
	echo "#define STRINGSIZE(s) STRINGSIZE2(s)" >> $TARGET_FILE
	echo "#define BUILD_STRING STRINGSIZE(MAJOR_VERSION) \".\" STRINGSIZE(MINOR_VERSION) \".\" \\" >> $TARGET_FILE
	echo "    STRINGSIZE(BUILD_VERSION) \".\" \\" >> $TARGET_FILE
	echo "    STRINGSIZE(PATCH_VERSION) \"    [\" BUILD_DATE \" \" BUILD_TIME \"]\"" >> $TARGET_FILE
fi
